\documentclass[12pt]{article}
\usepackage[utf8]{inputenc}

\usepackage{color,soul}
\usepackage{xcolor}
\usepackage{array}
\usepackage{mhchem}
\usepackage{mathtools}

\DeclarePairedDelimiter\ceil{\lceil}{\rceil}
\DeclarePairedDelimiter\floor{\lfloor}{\rfloor}

\bibliographystyle{plos2015}


\begin{document}


\section*{S1 Appendix: Tree operators for rate quantiles}




Zhang and Drummond 2020 introduced several tree operators for the \textit{real} parameterisation -- including Constant Distance, Simple Distance, and Small Pulley \cite{zhang2020improving}.
In this appendix, these three operators are extended to the  the \textit{quant} parameterisation.
Following the notation presented in the main article, let $t_i$ be the time of node $i$, let $0 < q_i < 1$ be the rate quantile of node $i$, and let $r_i = F^{-1}(q_i)$ be the real rate of node $i$ where $F^{-1}$ is the inverse cumulative density function (i-CDF).








\subsection*{Constant Distance}



Let $\mathcal{X}$ be a uniformly-at-random sampled internal node on tree $\mathcal{T}$. Let $\mathcal{L}$ and $\mathcal{R}$ be the left and right child of $\mathcal{X}$, respectively, and let $\mathcal{P}$ be the parent of $\mathcal{X}$. 
Under the \textit{quant} parameterisation, the \texttt{ConstantDistance} operator works as follows: \\


\textul{\textit{Step 1}}. Propose a new height for $t_\mathcal{X}$:

\begin{align}
	{t_\mathcal{X}}^\prime \leftarrow t_\mathcal{X} + s\Sigma
\end{align}

where $\Sigma$ is drawn from a proposal transition distribution (Uniform or Bactrian), and $s$ is a tunable step size. Ensure that $\max\{t_\mathcal{L}, t_\mathcal{R} \} < {t_\mathcal{X}}^\prime < t_\mathcal{P}$, and if the constraint is broken then reject the proposal.  \\


\textul{\textit{Step 2}}. Recalculate $q_\mathcal{X}$ as:



\begin{align}
	{q_\mathcal{X}}^\prime  \leftarrow & F\Big({r_\mathcal{X}}^\prime \Big) \nonumber\\
				\leftarrow & F\Big(\frac{t_\mathcal{P} - t_\mathcal{X}}{t_\mathcal{P} - {t_\mathcal{X}}^\prime} r_X \Big)\nonumber \\
				\leftarrow & F\Big(\frac{t_\mathcal{P} - t_\mathcal{X}}{t_\mathcal{P} - {t_\mathcal{X}}^\prime} F^{-1}(q_\mathcal{X}) \Big).
\end{align}


This ensures that the genetic distance between $\mathcal{X}$ and $P$ remains constant after the operation by enforcing the constraint:


\begin{align}
	r_\mathcal{X} (t_\mathcal{P} - t_\mathcal{X}) = {r_\mathcal{X}}^\prime (t_\mathcal{P} - {t_\mathcal{X}}^\prime).
\end{align}




\textul{\textit{Step 3}}. Similarly, propose new rate quantiles for the two children $\mathcal{C} \in \{\mathcal{L}, \mathcal{R}\}$:



\begin{align}
	{q_\mathcal{C}}^\prime  \leftarrow & F\Big({r_\mathcal{C}}^\prime \Big) \nonumber\\
				\leftarrow & F\Big(\frac{t_\mathcal{X} - t_\mathcal{C}}{{t_\mathcal{X}}^\prime - t_\mathcal{C}} \times r_\mathcal{C} \Big) \nonumber\\
				\leftarrow & F\Big(\frac{t_\mathcal{X} - t_\mathcal{C}}{{t_\mathcal{X}}^\prime - t_\mathcal{C}} \times F^{-1}(q_\mathcal{C}) \Big).
\end{align}


Ensure that $0 < {q_i}^\prime < 1$ for all proposed nodes $i \in \{\mathcal{X}, L, R\}$, and if the constraint is broken then reject the proposal. 
This constraint can only be broken from numerical issues.





\textul{\textit{Step 4}}. Finally, in order to calculate the Metropolis-Hastings-Green ratio, return the determinant of the Jacobian matrix:






\begin{align}
	J &= \begin{bmatrix} \frac{\partial {t_\mathcal{X}}^\prime}{\partial t_\mathcal{X}} & \frac{\partial {t_\mathcal{X}}^\prime}{\partial q_\mathcal{X}} & \frac{\partial {t_\mathcal{X}}^\prime}{\partial q_\mathcal{L}} & \frac{\partial {t_\mathcal{X}}^\prime}{\partial q_\mathcal{R}} \\
			\frac{\partial {q_\mathcal{X}}^\prime}{\partial t_\mathcal{X}} & \frac{\partial {q_\mathcal{X}}^\prime}{\partial q_\mathcal{X}} & \frac{\partial {q_\mathcal{X}}^\prime}{\partial q_\mathcal{L}} & \frac{\partial {q_\mathcal{X}}^\prime}{\partial q_\mathcal{R}} \\
			\frac{\partial {q_\mathcal{L}}^\prime}{\partial t_\mathcal{X}} & \frac{\partial {q_\mathcal{L}}^\prime}{\partial q_\mathcal{X}} & \frac{\partial {q_\mathcal{L}}^\prime}{\partial q_\mathcal{L}} & \frac{\partial {q_\mathcal{L}}^\prime}{\partial q_\mathcal{R}} \\
			\frac{\partial {q_\mathcal{R}}^\prime}{\partial t_\mathcal{X}} & \frac{\partial {q_\mathcal{R}}^\prime}{\partial q_\mathcal{X}} & \frac{\partial {q_\mathcal{R}}^\prime}{\partial q_\mathcal{L}} & \frac{\partial {q_\mathcal{R}}^\prime}{\partial q_\mathcal{R}} \\ \end{bmatrix} \nonumber \\
			&= \begin{bmatrix} \frac{\partial {t_\mathcal{X}}^\prime}{\partial t_\mathcal{X}} & 0 & 0 & 0 \\
			\frac{\partial {q_\mathcal{X}}^\prime}{\partial t_\mathcal{X}} & \frac{\partial {q_\mathcal{X}}^\prime}{\partial q_\mathcal{X}} & 0 & 0 \\
			\frac{\partial {q_\mathcal{L}}^\prime}{\partial t_\mathcal{X}} & 0 & \frac{\partial {q_\mathcal{L}}^\prime}{\partial q_\mathcal{L}} & 0 \\
			\frac{\partial {q_\mathcal{R}}^\prime}{\partial t_\mathcal{X}} & 0 & 0 & \frac{\partial {q_\mathcal{R}}^\prime}{\partial q_\mathcal{R}} \\ \end{bmatrix}.
\end{align}


As $J$ is triangular, its determinant $|J|$ is equal to the product of diagonal elements:


\begin{align}
	\ln |J| =&  \ln \{ \frac{\partial {t_\mathcal{X}}^\prime}{\partial t_\mathcal{X}} \times \frac{\partial {q_\mathcal{X}}^\prime}{\partial q_\mathcal{X}} \times \frac{\partial {q_\mathcal{L}}^\prime}{\partial q_\mathcal{L}} \times \frac{\partial {q_\mathcal{R}}^\prime}{\partial q_\mathcal{R}} \} \nonumber\\
		=& \ln 1 + \ln \; D F\Big( \frac{t_\mathcal{P} - t_\mathcal{X}}{t_\mathcal{P} - {t_\mathcal{X}}^\prime} \times F^{-1}(q_\mathcal{X})  \Big) + \ln \frac{\partial}{\partial q_\mathcal{X}}  \frac{t_\mathcal{P} - t_\mathcal{X}}{t_\mathcal{P} - {t_\mathcal{X}}^\prime} F^{-1} \Big( q_\mathcal{X} \Big) \nonumber\\
		& + \ln \; DF\Big( \frac{t_X - t_\mathcal{L}}{{t_\mathcal{X}}^\prime - t_\mathcal{L}} \times F^{-1}(q_\mathcal{L}) \Big) + \ln \frac{\partial}{\partial q_\mathcal{L}} \frac{t_\mathcal{X} - t_\mathcal{L}}{{t_\mathcal{X}}^\prime - t_\mathcal{L}} F^{-1} \Big( q_\mathcal{L} \Big) \nonumber\\
		& + \ln \; D F\Big( \frac{t_\mathcal{X} - t_\mathcal{R}}{{t_\mathcal{X}}^\prime - t_\mathcal{R}} \times F^{-1}(q_\mathcal{R}) \Big) + \ln \frac{\partial}{\partial q_\mathcal{R}} \frac{t_\mathcal{X} - t_\mathcal{R}}{{t_\mathcal{X}}^\prime - t_\mathcal{R}} F^{-1} \Big( q_\mathcal{R} \Big) \nonumber\\
		=& \ln \; D F\Big( \frac{t_\mathcal{P} - t_\mathcal{X}}{t_\mathcal{P} - {t_\mathcal{X}}^\prime} \times F^{-1}(q_\mathcal{X})  \Big) + \ln \; D  F^{-1} \Big( q_\mathcal{X} \Big) + \ln \frac{t_\mathcal{P} - t_\mathcal{X}}{t_\mathcal{P} - {t_\mathcal{X}}^\prime} \nonumber\\
		& + \ln \; DF\Big( \frac{t_\mathcal{X} - t_\mathcal{L}}{{t_\mathcal{X}}^\prime - t_\mathcal{L}} \times F^{-1}(q_\mathcal{L}) \Big) + \ln \; D F^{-1} \Big( q_\mathcal{L} \Big) + \ln  \frac{t_\mathcal{X} - t_\mathcal{L}}{{t_\mathcal{X}}^\prime - t_\mathcal{L}} \nonumber \\
		& + \ln \; D F\Big( \frac{t_\mathcal{X} - t_\mathcal{R}}{{t_\mathcal{X}}^\prime - t_\mathcal{R}} \times F^{-1}(q_\mathcal{R}) \Big) + \ln \; DF^{-1} \Big( q_\mathcal{R} \Big) + \ln \frac{t_\mathcal{X} - t_\mathcal{R}}{{t_\mathcal{X}}^\prime - t_\mathcal{R}} .
\end{align}







The derivatives $DF$ and $DF^{-1}$ can be computed using numerical approximations.
 As its final step, the operator returns $\ln |J|$. 




\subsection*{Simple Distance}

While \texttt{ConstantDistance} proposes internal node heights, \texttt{SimpleDistance} operates on the root. Let $\mathcal{X}$ be the root node and let $\mathcal{L}$ and $\mathcal{R}$ be its two children.

\textul{\textit{Step 1}}. Propose a new height for $t_\mathcal{X}$:

\begin{align}
	{t_\mathcal{X}}^\prime \leftarrow t_\mathcal{X} + s\Sigma
\end{align}

Ensure that $\max\{t_\mathcal{L}, t_\mathcal{R} \} < {t_\mathcal{X}}^\prime$, and if the constraint is broken then reject the proposal.  \\


\textul{\textit{Step 2}}. Propose new rate quantiles for the two children $\mathcal{C} \in \{\mathcal{L}, \mathcal{R}\}$:



\begin{align}
	{q_\mathcal{C}}^\prime  \leftarrow & F\Big({r_\mathcal{C}}^\prime \Big)  \nonumber \\
				\leftarrow & F \Big( \frac{t_\mathcal{X} - t_\mathcal{C}}{{t_\mathcal{X}}^\prime - t_\mathcal{C}} \times r_\mathcal{C} \Big) \nonumber \\
				\leftarrow & F \Big( \frac{t_\mathcal{X} - t_\mathcal{C}}{{t_\mathcal{X}}^\prime - t_\mathcal{C}} \times F^{-1}(q_\mathcal{C}) \Big).
\end{align}




These proposals ensure that the genetic distance between $\mathcal{X}$ and its children $\mathcal{C}$ remain constant after the operation by enforcing the constraint:


\begin{align}
	r_\mathcal{C} (t_\mathcal{X} - t_\mathcal{C}) = {r_\mathcal{C}}^\prime ({t_\mathcal{X}}^\prime - t_\mathcal{C}).
\end{align}


Ensure that $0 < {q_C}^\prime < 1$, and if the constraint is broken then reject the proposal. 



\textul{\textit{Step 3}}. Finally, in order to calculate the Metropolis-Hastings-Green ratio, return the determinant of the Jacobian matrix:



\begin{align}
	J &= \begin{bmatrix} \frac{\partial {t_\mathcal{X}}^\prime}{\partial t_\mathcal{X}} & \frac{\partial {t_\mathcal{X}}^\prime}{\partial q_\mathcal{L}} & \frac{\partial {t_\mathcal{X}}^\prime}{\partial q_\mathcal{R}} \\
						\frac{\partial {q_\mathcal{L}}^\prime}{\partial t_\mathcal{X}} & \frac{\partial {q_\mathcal{L}}^\prime}{\partial q_\mathcal{L}} & \frac{\partial {q_\mathcal{L}}^\prime}{\partial q_\mathcal{R}} \\
						\frac{\partial {q_\mathcal{R}}^\prime}{\partial t_\mathcal{X}} & \frac{\partial {q_\mathcal{R}}^\prime}{\partial q_\mathcal{L}} & \frac{\partial {q_\mathcal{R}}^\prime}{\partial q_\mathcal{R}} \end{bmatrix} \nonumber \\
		&= \begin{bmatrix} \frac{\partial {t_\mathcal{X}}^\prime}{\partial t_\mathcal{X}} & 0 & 0 \\
						\frac{\partial {q_\mathcal{L}}^\prime}{\partial t_\mathcal{X}} & \frac{\partial {q_\mathcal{L}}^\prime}{\partial q_\mathcal{L}} & 0\\
						\frac{\partial {q_\mathcal{R}}^\prime}{\partial t_\mathcal{X}} & 0 & \frac{\partial {q_\mathcal{R}}^\prime}{\partial q_\mathcal{R}} \end{bmatrix}.
\end{align}



As $J$ is triangular, its determinant $|J|$ is equal to the product of diagonal elements:


\begin{align}
	\ln |J| =&  \ln \{ \frac{\partial {t_\mathcal{X}}^\prime}{\partial t_\mathcal{X}} \times \frac{\partial {q_\mathcal{L}}^\prime}{\partial q_\mathcal{L}} \times \frac{\partial {q_\mathcal{R}}^\prime}{\partial q_\mathcal{R}} \} \nonumber \\
			=& \ln \frac{\partial {t_\mathcal{X}}^\prime}{\partial t_\mathcal{X}} +  \ln \frac{\partial {q_\mathcal{L}}^\prime}{\partial q_\mathcal{L}} + \ln \frac{\partial {q_\mathcal{R}}^\prime}{\partial q_\mathcal{R}} \nonumber \\
			=& \ln 1  \nonumber\\
			&+ \ln \; D F\Big( \frac{t_\mathcal{X} - t_\mathcal{L}}{{t_\mathcal{X}}^\prime - t_\mathcal{L}} \times F^{-1}(q_\mathcal{L}) \Big) + \ln \frac{\partial}{\partial q_\mathcal{L}} \frac{t_\mathcal{X} - t_\mathcal{L}}{{t_\mathcal{X}}^\prime - t_\mathcal{L}} F^{-1} \Big( q_\mathcal{L} \Big) \nonumber\\
			&+ \ln \; D F\Big( \frac{t_\mathcal{X} - t_\mathcal{R}}{{t_\mathcal{X}}^\prime - t_\mathcal{R}}\times F^{-1}(q_\mathcal{R}) \Big) + \ln \frac{\partial}{\partial q_\mathcal{R}} \frac{t_\mathcal{X} - t_\mathcal{R}}{{t_\mathcal{X}}^\prime - t_\mathcal{R}} F^{-1} \Big( q_\mathcal{R} \Big) \nonumber\\
			=& \ln \; D F\Big( \frac{t_\mathcal{X} - t_\mathcal{L}}{{t_\mathcal{X}}^\prime - t_\mathcal{L}} \times F^{-1}(q_\mathcal{L}) \Big) + \ln \; D F^{-1} \Big( q_\mathcal{L} \Big) + \ln \frac{t_\mathcal{X} - t_\mathcal{L}}{{t_\mathcal{X}}^\prime - t_\mathcal{L}}\nonumber \\
			&+ \ln \; D F\Big( \frac{t_\mathcal{X} - t_\mathcal{R}}{{t_\mathcal{X}}^\prime - t_\mathcal{R}}\times F^{-1}(q_\mathcal{R}) \Big) + \ln \; D F^{-1} \Big( q_\mathcal{R} \Big) + \ln  \frac{t_\mathcal{X} - t_\mathcal{R}}{{t_\mathcal{X}}^\prime - t_\mathcal{R}}.
\end{align}


As its final step, the operator returns $\ln |J|$. 


\subsection*{Small Pulley}

Just like the previous operator, \texttt{SmallPulley} operates on the root. 
Let $\mathcal{X}$ be the root node and let $\mathcal{L}$ and $\mathcal{R}$ be its two children.
However, unlike \texttt{SimpleDistance}, this operator alters the two genetic distances $d_\mathcal{L} = r_\mathcal{L} (t_\mathcal{X} - t_\mathcal{L}) = F^{-1} (q_\mathcal{L}) (t_\mathcal{X} - t_\mathcal{L})$ and $d_\mathcal{R} = r_\mathcal{R} (t_\mathcal{X} - t_\mathcal{R}) = F^{-1} (q_\mathcal{R}) (t_\mathcal{X} - t_\mathcal{R})$, while conserving their sum $d_\mathcal{L} + d_\mathcal{R}$.



\textul{\textit{Step 1}}. Propose new genetic distances for $d_\mathcal{L}$ and $d_\mathcal{R}$:

\begin{align}
	{d_\mathcal{L}}^\prime & \leftarrow d_\mathcal{L} + s\Sigma \\
	{d_\mathcal{R}}^\prime & \leftarrow d_\mathcal{R} - s\Sigma
\end{align}


Ensure that $0 < {d_\mathcal{L}}^\prime < d_\mathcal{L} + d_\mathcal{R}$, and if the constraint is broken then reject the proposal.  \\




\textul{\textit{Step 2}}. Propose new rate quantiles for the two children $\mathcal{L}$ and $\mathcal{R}$:


\begin{align}
	{q_\mathcal{L}}^\prime &\leftarrow F\big( \frac{{d_\mathcal{L}}^\prime}{t_\mathcal{X} - t_\mathcal{L}} \big) \nonumber\\
				 &\leftarrow F\big( \frac{F^{-1} (q_\mathcal{L}) (t_\mathcal{X} - t_\mathcal{L}) + \Sigma}{t_\mathcal{X} - t_\mathcal{L}} \big) \\
	{q_\mathcal{R}}^\prime &\leftarrow F\big( \frac{{d_\mathcal{R}}^\prime}{t_\mathcal{X} - t_\mathcal{R}} \big) \nonumber \\
				 &\leftarrow F\big( \frac{F^{-1} (q_\mathcal{R}) (t_\mathcal{X} - t_\mathcal{R}) - \Sigma}{t_\mathcal{X} - t_\mathcal{R}} \big).
\end{align}



\textul{\textit{Step 3}}. Return the determinant of the Jacobian matrix:


\begin{align}
	J &= \begin{bmatrix} \frac{\partial {q_\mathcal{L}}^\prime}{\partial q_\mathcal{L}} & \frac{\partial {q_\mathcal{L}}^\prime}{\partial q_\mathcal{R}} \\
						 \frac{\partial {q_\mathcal{R}}^\prime}{\partial q_\mathcal{L}} & \frac{\partial {q_\mathcal{R}}^\prime}{\partial q_\mathcal{R}} \end{bmatrix} \nonumber \\
	 &= \begin{bmatrix} \frac{\partial {q_\mathcal{L}}^\prime}{\partial q_\mathcal{L}} & 0 \\
						 0 & \frac{\partial {q_\mathcal{R}}^\prime}{\partial q_\mathcal{R}} \end{bmatrix}
\end{align}


As $J$ is triangular/diagonal, its determinant $|J|$ is equal to the product of diagonal elements:



\begin{align}
	\ln |J| =&  \ln \{ \frac{\partial {q_\mathcal{L}}^\prime}{\partial q_\mathcal{L}} \times \frac{\partial {q_\mathcal{R}}^\prime}{\partial q_\mathcal{R}} \} \nonumber \\
			=& \ln  \frac{\partial {q_\mathcal{L}}^\prime}{\partial q_\mathcal{L}} + \ln \frac{\partial {q_\mathcal{R}}^\prime}{\partial q_\mathcal{R}}\nonumber \\
			=& \ln \; D F\big( \frac{F^{-1} (q_\mathcal{L}) (t_\mathcal{X} - t_\mathcal{L}) + \Sigma}{t_\mathcal{X} - t_\mathcal{L}} \big) + \ln \frac{\partial {q_\mathcal{L}}^\prime}{\partial q_\mathcal{L}}  \frac{F^{-1} (q_\mathcal{L}) (t_\mathcal{X} - t_\mathcal{L}) + \Sigma}{t_\mathcal{X} - t_\mathcal{L}} \nonumber\\
			&+ \ln \; D F\big( \frac{F^{-1} (q_\mathcal{R}) (t_\mathcal{X} - t_\mathcal{R}) - \Sigma}{t_\mathcal{X} - t_\mathcal{R}} \big) + \ln \frac{\partial {q_\mathcal{R}}^\prime}{\partial q_\mathcal{R}}  \frac{F^{-1} (q_\mathcal{R}) (t_\mathcal{X} - t_\mathcal{R}) - \Sigma}{t_\mathcal{X} - t_\mathcal{R}} \nonumber\\
			=& \ln \; D F\big( \frac{F^{-1} (q_\mathcal{L}) (t_\mathcal{X} - t_\mathcal{L}) + \Sigma}{t_\mathcal{X} - t_\mathcal{L}} \big) + \ln \; D F^{-1} (q_\mathcal{L}) \nonumber \\
			&+ \ln \; D F\big( \frac{F^{-1} (q_\mathcal{R}) (t_\mathcal{X} - t_\mathcal{R}) - \Sigma}{t_\mathcal{X} - t_\mathcal{R}} \big) + \ln \; DF^{-1} (q_\mathcal{R}) .
\end{align}


Thus, as its final step, the operator returns $\ln |J|$.





\bibliography{references}




\end{document}